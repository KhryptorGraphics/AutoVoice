# Validation Scripts Guide

## Overview

This guide documents the Docker deployment validation and full validation orchestration scripts for AutoVoice.

## Scripts

### 1. Docker Deployment Validation (`scripts/test_docker_deployment.sh`)

**Purpose**: Validates Docker image build, container startup, and API functionality with comprehensive health checks.

**Features**:
- Builds `autovoice:validation` Docker image
- Runs container with GPU support (if available)
- Tests health endpoints (`/health`, `/health/live`, `/health/ready`)
- Verifies GPU availability via `/api/v1/gpu_status`
- Tests API endpoint (`/api/v1/voice/profiles`)
- Executes `nvidia-smi` in container for GPU metrics
- Analyzes container logs for errors
- Comprehensive logging to `validation_results/docker_validation.log`

**Usage**:
```bash
# Run Docker validation
bash scripts/test_docker_deployment.sh

# Results written to: validation_results/docker_validation.log
```

**Requirements**:
- Docker installed and running
- Dockerfile at project root
- Port 5000 available
- (Optional) NVIDIA GPU and nvidia-docker for GPU tests

**Exit Codes**:
- `0`: All validations passed
- `1`: One or more validations failed

**Validation Steps**:
1. Environment check (Docker, GPU detection)
2. Docker image build
3. Container startup with timeout handling
4. Health endpoint tests
5. GPU status verification (GPU hosts only)
6. API endpoint tests
7. GPU utilization sampling (via nvidia-smi)
8. Log analysis for errors
9. Cleanup (automatic on exit)

### 2. Full Validation Orchestrator (`scripts/run_full_validation.sh`)

**Purpose**: Coordinates all validation tests and generates comprehensive validation reports.

**Features**:
- Orchestrates multiple validation phases
- Tracks validation statistics (passed/failed/skipped)
- Generates timestamped summary logs
- Graceful handling of optional validations
- GPU-aware test execution
- Comprehensive reporting

**Usage**:
```bash
# Run full validation suite
bash scripts/run_full_validation.sh

# Results written to: validation_results/validation_summary_<timestamp>.log
```

**Validation Phases** (in order):

1. **Environment Check**
   - Python version verification
   - Virtual environment detection
   - GPU availability check

2. **Test Data Generation** (optional)
   - Executes: `python tests/data/validation/generate_test_data.py`
   - Generates synthetic test data for validation

3. **System Validation Tests**
   - Executes: `pytest tests/test_system_validation.py -v --tb=short`
   - Comprehensive system-level testing

4. **Code Quality Validation**
   - Executes: `python scripts/validate_code_quality.py`
   - Code style, complexity, and quality checks

5. **Integration Validation**
   - Executes: `python scripts/validate_integration.py`
   - Cross-component integration testing

6. **Documentation Validation**
   - Executes: `python scripts/validate_documentation.py`
   - Documentation completeness and accuracy checks

7. **Docker Deployment Validation** (optional on CPU systems)
   - Executes: `bash scripts/test_docker_deployment.sh`
   - Full Docker deployment testing

8. **Voice Quality Evaluation** (optional)
   - Executes: `python examples/evaluate_voice_conversion.py --quick`
   - Audio quality metrics assessment

9. **Validation Report Generation**
   - Executes: `python scripts/generate_validation_report.py`
   - Generates comprehensive validation report

**Exit Codes**:
- `0`: All required validations passed
- `1`: One or more required validations failed

**Output**:
- Timestamped summary log: `validation_results/validation_summary_<timestamp>.log`
- Individual validation logs in `validation_results/`
- Final report: `FINAL_VALIDATION_REPORT.md` (if report generator exists)

## Validation Results Directory

All validation outputs are stored in `validation_results/`:

```
validation_results/
├── docker_validation.log           # Docker validation detailed log
├── validation_summary_<timestamp>.log  # Orchestrator summary
├── test_results.json               # Pytest results (if available)
└── <other validation artifacts>    # Generated by individual validators
```

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Full Validation

on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run full validation
        run: bash scripts/run_full_validation.sh

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: validation-results
          path: validation_results/
```

### Docker-Only Validation

```yaml
name: Docker Validation

on: [push]

jobs:
  docker-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Run Docker validation
        run: bash scripts/test_docker_deployment.sh

      - name: Upload Docker validation logs
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: docker-validation-log
          path: validation_results/docker_validation.log
```

## Troubleshooting

### Docker Validation Issues

**Issue**: "Docker is not installed or not in PATH"
- **Solution**: Install Docker: `curl -fsSL https://get.docker.com | sh`

**Issue**: "Container stopped unexpectedly"
- **Solution**: Check Docker logs in validation output, verify Dockerfile syntax

**Issue**: "CUDA is not available in container"
- **Solution**: Ensure nvidia-docker is installed and GPU drivers are loaded

**Issue**: "Service failed to start within 60 seconds"
- **Solution**: Increase `STARTUP_TIMEOUT` in script or check container resource constraints

### Full Validation Issues

**Issue**: Multiple validations skipped
- **Solution**: Ensure all validation scripts exist and are executable

**Issue**: "Validation suite failed" with high skip count
- **Solution**: Review which validators are missing and create/fix them

**Issue**: Permission denied errors
- **Solution**: Ensure scripts are executable: `chmod +x scripts/*.sh`

## Development

### Adding New Validations

To add a new validation phase to the orchestrator:

1. Create your validation script (e.g., `scripts/validate_new_feature.py`)
2. Add validation phase in `run_full_validation.sh`:

```bash
# Run new feature validation
if [ -f "scripts/validate_new_feature.py" ]; then
    run_validation \
        "New Feature Validation" \
        "python scripts/validate_new_feature.py" \
        false || true  # Set to true for optional validation
else
    log_skip "New feature validation script not found"
    SKIPPED_VALIDATIONS=$((SKIPPED_VALIDATIONS + 1))
fi
```

### Customizing Docker Validation

Edit `scripts/test_docker_deployment.sh` to:
- Change ports: Modify `API_PORT` variable
- Add endpoints: Add new curl tests in "Testing API Endpoints" section
- Adjust timeouts: Modify `STARTUP_TIMEOUT` variable
- Change image name: Modify `IMAGE_NAME` variable

## Performance Benchmarks

Typical execution times (CPU mode, all validators present):

| Validation Phase | Duration | Notes |
|-----------------|----------|-------|
| Test Data Generation | 5-10s | Synthetic data creation |
| System Tests | 30-60s | Full pytest suite |
| Code Quality | 10-20s | Static analysis |
| Integration | 20-40s | Component integration |
| Documentation | 5-10s | Doc completeness |
| Docker | 120-180s | Image build + container test |
| Quality Eval | 60-120s | Audio metrics (optional) |
| Report Generation | 5-10s | Final report assembly |

**Total**: ~4-7 minutes for full validation suite

## Best Practices

1. **Run locally before pushing**: Catch issues early
2. **Check validation logs**: Review logs in `validation_results/`
3. **Fix failures immediately**: Don't accumulate validation debt
4. **Keep validators fast**: Optimize slow validators
5. **Document custom validations**: Add to this guide when extending
6. **Use optional flag wisely**: Only for truly optional validations
7. **Monitor GPU tests**: Ensure GPU tests run in GPU environments

## See Also

- [Implementation Complete Guide](implementation_complete.md)
- [CUDA Optimization Guide](cuda_optimization_guide.md)
- [Quality Evaluation Guide](quality_evaluation_guide.md)
- [Verification Fixes](VERIFICATION_FIXES_REMAINING.md)
